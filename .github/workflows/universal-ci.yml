name: Universal Factory CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  detect-stack:
    name: Detect Tech Stack
    runs-on: ubuntu-latest
    outputs:
      manager: ${{ steps.detect.outputs.manager }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Analyze Repository
        id: detect
        run: |
          if [ -f "pubspec.yaml" ]; then
            echo "manager=flutter" >> $GITHUB_OUTPUT
            echo "✅ Detected Flutter"
          elif [ -f "package.json" ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "✅ Detected Node.js"
          elif [ -f "requirements.txt" ]; then
            echo "manager=python" >> $GITHUB_OUTPUT
            echo "✅ Detected Python"
          else
            echo "manager=unknown" >> $GITHUB_OUTPUT
            echo "⚠️ No standard package manager found"
          fi

  factory-run:
    name: Factory Floor
    needs: detect-stack
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # FLUTTER TRACK
      - name: Setup Flutter
        if: needs.detect-stack.outputs.manager == 'flutter'
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Flutter Build
        if: needs.detect-stack.outputs.manager == 'flutter'
        run: |
          flutter pub get
          flutter test || echo "No tests found"

      # NODE TRACK
      - name: Setup Node
        if: needs.detect-stack.outputs.manager == 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Node Build
        if: needs.detect-stack.outputs.manager == 'npm'
        run: |
          npm ci
          npm test -- --passWithNoTests || true

      # PYTHON TRACK
      - name: Setup Python
        if: needs.detect-stack.outputs.manager == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Python Build
        if: needs.detect-stack.outputs.manager == 'python'
        run: |
          pip install -r requirements.txt || true
          pip install pytest || true
          pytest || echo "No tests found"

  tier-check:
    name: Safety Gate
    needs: factory-run
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check Tier Level
        run: |
          SENSITIVE=$(git diff --name-only origin/main HEAD | grep -E "auth/|infrastructure/" || true)
          if [ ! -z "$SENSITIVE" ]; then
             echo "::notice::TIER 2 CHANGE DETECTED: Admin approval required."
          else
             echo "✅ TIER 1 CHANGE: Standard automation applied."
          fi